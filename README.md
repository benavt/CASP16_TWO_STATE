# CASP Data Processing

This repository contains scripts and utilities for processing, analyzing, and visualizing data for the CASP (Critical Assessment of Structure Prediction) assessment. The workflow includes processing scores, identifying missing data points, and generating plots and summary files.

## Directory Structure

```
CASP_DATA_PROCESSING/
├── DATA/              # Contains gathered data files (input for processing)
├── OUTPUT/            # Output CSVs and summary files generated by scripts
├── PLOTS/             # Generated plots and visualizations
├── LATEX_TABLES/      # LaTeX table files for publication
├── LATEX_TABLES_BALANCE/ # LaTeX table files with balance metrics
├── TSBI_PLOTS/        # TSBI score bar plots and visualizations
├── archive_plots/     # Archived plots and PDFs from previous runs
├── process_two_state_score.py    # Processes two-state scores for all targets
├── process_two_state_score_TSBI.py # Processes two-state scores with TSBI calculation
├── process_two_state_score_full_axis.py # Processes two-state scores with full axis plots
├── process_two_state_score_simple_bar_plots.py # Processes two-state scores with simple bar plots
├── process_TM_GDT_two_state_multipanel.py # Creates multi-panel plots for TM and GDT scores
├── process_single_state_score.py # Processes single-state scores for specific targets
├── create_latex_tables.py       # Generates LaTeX tables for publication
├── create_latex_tables_with_balance.py # Generates LaTeX tables with balance metrics
├── group_number_name_correspondance.csv  # Group number to name mapping
├── CASP16_TWO_STATE_TABLES_ALL.pdf # Combined PDF of all two-state tables
├── CASP16_TWO_STATE_TABLES_BALANCE_ALL.pdf # Combined PDF of all balance tables
└── CASP16_TWO_STATE_TABLES.pdf # Legacy PDF of two-state tables
```

## Prerequisites

- Python 3.7+
- Required Python packages:
  - pandas
  - matplotlib
  - adjustText
  - tqdm

Install dependencies with:
```bash
pip install pandas matplotlib adjustText tqdm
```

## Script Overview and Usage

### 1. `process_two_state_score.py`
**Purpose**: Processes the gathered data to compute two-state scores for each target and score type, generates summary CSVs in `OUTPUT/`, and creates scatter and bar plots in `PLOTS/`.

**Usage:**
```bash
python process_two_state_score.py
```

**What it does:**
- Automatically processes all targets and score types defined in `TARGET_SCORE_DICT`
- Computes two-state scores by combining the best scores from different model/version combinations
- Generates scatter plots comparing V1 vs V2 reference states
- Creates stacked bar charts showing combined scores
- Saves detailed CSV outputs with all scoring information
- Handles special cases for different targets (M1228, M1239, R1203, T1214, T1228, T1239, T1249)

**Targets and Score Types Processed:**
- **M1228**: BestDockQ, GDT_TS, GlobDockQ, GlobalLDDT, TMscore
- **M1239**: BestDockQ, GDT_TS, GlobDockQ, GlobalLDDT, TMscore
- **R1203**: GDT_TS, GlobalLDDT, Composite_Score_4, TMscore
- **T1214**: GDT_TS, GlobalLDDT, TMscore, Composite_Score_4
- **T1228**: GDT_TS, GlobalLDDT, TMscore
- **T1239**: GDT_TS, GlobalLDDT, TMscore
- **T1249**: AvgDockQ, GlobalLDDT, GDT_TS, TMscore

### 2. `process_two_state_score_full_axis.py`
**Purpose**: Processes two-state scores with full axis visualization, providing detailed scatter plots with complete axis ranges and enhanced visual features.

**Usage:**
```bash
python process_two_state_score_full_axis.py
```

**What it does:**
- Similar functionality to the standard two-state processor but with enhanced plotting
- Creates scatter plots with full axis ranges for better data visualization
- Includes additional visual features and annotations
- Generates more detailed plots suitable for publication
- Handles the same targets and score types as the standard processor

### 3. `process_two_state_score_simple_bar_plots.py`
**Purpose**: Processes two-state scores with simplified bar plot visualizations, focusing on clean and minimal design.

**Usage:**
```bash
python process_two_state_score_simple_bar_plots.py
```

**What it does:**
- Creates simplified bar plots with minimal visual elements
- Focuses on clean, publication-ready visualizations
- Reduces visual clutter while maintaining data clarity
- Generates both horizontal and vertical bar plots
- Handles the same targets and score types as the standard processor

### 4. `process_TM_GDT_two_state_multipanel.py`
**Purpose**: Creates multi-panel plots specifically for TM and GDT scores, providing comprehensive visualization of these key metrics.

**Usage:**
```bash
python process_TM_GDT_two_state_multipanel.py
```

**What it does:**
- Creates multi-panel plots combining TM and GDT score visualizations
- Provides comprehensive view of these critical assessment metrics
- Generates publication-ready multi-panel figures
- Combines scatter plots and bar charts in unified layouts
- Focuses on TM and GDT scores across all relevant targets

### 5. `process_single_state_score.py`
**Purpose**: Processes single-state scores for targets that only have one reference state (currently T1214).

**Usage:**
```bash
python process_single_state_score.py
```

**What it does:**
- Processes targets that don't have V1/V2 reference state comparisons
- Generates single-state scoring analysis
- Creates appropriate visualizations for single-state data
- Currently configured for T1214 with GDT_TS, GlobalLDDT, TMscore, and Composite_Score_4

### 6. `create_latex_tables.py`
**Purpose**: Generates LaTeX table files from the processed CSV outputs for publication purposes.

**Usage:**
```bash
python create_latex_tables.py
```

**What it does:**
- Reads all CSV files from the `OUTPUT/` directory
- Converts them to properly formatted LaTeX tables
- Handles special formatting for publication (decimal places, underscores, etc.)
- Creates a special T1214 Sigma4 score table
- Saves all tables to the `LATEX_TABLES/` directory

### 7. `create_latex_tables_with_balance.py`
**Purpose**: Generates LaTeX table files with balance metrics, providing additional insights into performance consistency across reference states.

**Usage:**
```bash
python create_latex_tables_with_balance.py
```

**What it does:**
- Creates LaTeX tables that include balance metrics alongside performance scores
- Provides additional columns for V1 and V2 reference state scores
- Includes balance calculations to assess consistency across reference states
- Generates publication-ready tables with enhanced metrics
- Saves tables to the `LATEX_TABLES_BALANCE/` directory

### 8. `process_two_state_score_TSBI.py`
**Purpose**: Processes two-state scores with TSBI (Two-State Balance Index) calculation, providing a balanced assessment metric that considers both performance and consistency across reference states.

**Usage:**
```bash
python process_two_state_score_TSBI.py
```

**What it does:**
- Automatically processes all targets and score types defined in `TARGET_SCORE_DICT`
- Computes TSBI scores that balance performance with consistency across V1 and V2 reference states
- Generates horizontal and vertical bar plots showing TSBI scores for each group
- Creates special highlighting for AF3-server (group 304) with optional star markers
- Saves detailed CSV outputs with TSBI scoring information
- Handles the same targets and score types as the standard two-state processor

**TSBI Score Calculation:**
The TSBI score combines performance and balance using the following mathematical formula:

```
TSBI = Balance × (V1_ref + V2_ref)
```

Where:
- **Balance** = 1 - |V1_ref - V2_ref| / (V1_ref + V2_ref)
- **V1_ref** = Best score using V1 reference state
- **V2_ref** = Best score using V2 reference state

**Mathematical Properties:**
- **Balance factor** ranges from 0 to 1:
  - **Balance = 1**: Perfect balance (V1_ref = V2_ref)
  - **Balance = 0**: Maximum imbalance (one reference state has score 0)
- **TSBI = 0**: When either V1_ref or V2_ref equals 0
- **TSBI = -1**: Special case indicating insufficient data for calculation

**Advantages of TSBI:**
- Rewards groups that perform consistently across both reference states
- Penalizes groups with highly imbalanced performance
- Provides a single metric that captures both overall performance and consistency
- Useful for identifying robust prediction methods

**Targets and Score Types Processed:**
- **M1228**: BestDockQ, GDT_TS, GlobDockQ, GlobalLDDT, TMscore
- **M1239**: BestDockQ, GDT_TS, GlobDockQ, GlobalLDDT, TMscore
- **R1203**: GDT_TS, GlobalLDDT, Composite_Score_4, TMscore
- **T1214**: GDT_TS, GlobalLDDT, TMscore, Composite_Score_4
- **T1228**: GDT_TS, GlobalLDDT, TMscore
- **T1239**: GDT_TS, GlobalLDDT, TMscore
- **T1249**: AvgDockQ, GlobalLDDT, GDT_TS, TMscore

## Complete Workflow

1. **Process Two-State Scores:**
   ```bash
   python process_two_state_score.py
   ```

2. **Process Two-State Scores with TSBI:**
   ```bash
   python process_two_state_score_TSBI.py
   ```

3. **Process Two-State Scores with Full Axis:**
   ```bash
   python process_two_state_score_full_axis.py
   ```

4. **Process Two-State Scores with Simple Bar Plots:**
   ```bash
   python process_two_state_score_simple_bar_plots.py
   ```

5. **Create Multi-Panel TM/GDT Plots:**
   ```bash
   python process_TM_GDT_two_state_multipanel.py
   ```

6. **Process Single-State Scores (if applicable):**
   ```bash
   python process_single_state_score.py
   ```

7. **Generate LaTeX Tables:**
   ```bash
   python create_latex_tables.py
   ```

8. **Generate LaTeX Tables with Balance:**
   ```bash
   python create_latex_tables_with_balance.py
   ```

## Output Files

### CSV Outputs (`OUTPUT/` directory)
Each output CSV file contains detailed scoring information with columns:
- **Group**: The submission group identifier (e.g., TS314)
- **Group_Name**: Human-readable group name
- **TSBI_Score**: Two-State Balance Index score (for TSBI processor)
- **Combined_Score**: The sum of the two best scores for the group
- **Best_v1_ref**: The best score using a v1 reference
- **Best_v2_ref**: The best score using a v2 reference
- **V1_Model_For_Combined_Score**: Model identifier for the V1 score
- **V2_Model_For_Combined_Score**: Model identifier for the V2 score
- **Best_Score**: The highest score among all combinations
- **Best_Source**: Which combination produced the best score
- **v1_v1_Score, v1_v2_Score, v2_v1_Score, v2_v2_Score**: Individual scores for each combination
- **v1_v1_ModelNumber, v1_v2_ModelNumber, v2_v1_ModelNumber, v2_v2_ModelNumber**: Model numbers for each score

### Plots (`PLOTS/` directory)
- **Scatter plots**: Comparing V1 vs V2 reference states
- **Stacked bar charts**: Horizontal and vertical versions with and without special highlighting
- **Special features**: AF3 baseline highlighting, inset zoom regions for specific targets
- **Full axis plots**: Enhanced scatter plots with complete axis ranges
- **Simple bar plots**: Clean, minimal bar chart visualizations
- **Multi-panel plots**: Combined TM and GDT score visualizations

### TSBI Plots (`TSBI_PLOTS/` directory)
- **TSBI bar plots**: Horizontal and vertical bar charts showing TSBI scores for each group
- **AF3 highlighting**: Special highlighting for group 304 (AF3) with optional star markers
- **Multiple variants**: Star and no-star versions for both horizontal and vertical orientations

### LaTeX Tables (`LATEX_TABLES/` directory)
- Publication-ready LaTeX tables for all processed data
- Proper formatting and escaping for academic publication
- Special T1214 Sigma4 score table

### LaTeX Tables with Balance (`LATEX_TABLES_BALANCE/` directory)
- LaTeX tables including balance metrics
- Additional columns for V1 and V2 reference state scores
- Balance calculations for performance consistency assessment

### PDF Reports
- **CASP16_TWO_STATE_TABLES_ALL.pdf**: Combined PDF of all two-state tables
- **CASP16_TWO_STATE_TABLES_BALANCE_ALL.pdf**: Combined PDF of all balance tables
- **CASP16_TWO_STATE_TABLES.pdf**: Legacy PDF of two-state tables

### Archive (`archive_plots/` directory)
- **PLOTS/**: Archived plot files from previous runs
- **TSBI_PLOTS/**: Archived TSBI plot files
- **PDF files**: Archived PDF reports from previous processing runs

## Special Features

- **AF3 Baseline Highlighting**: Special highlighting for group 304 (AF3) in relevant plots
- **Inset Zoom Regions**: Detailed zoom views for specific target/score combinations
- **Dynamic Plot Sizing**: Automatic adjustment of plot dimensions based on number of groups
- **Group Name Mapping**: Automatic conversion of group numbers to human-readable names
- **Error Handling**: Robust error handling for missing data or processing issues
- **Multiple Plot Variants**: Different visualization styles (full axis, simple, multi-panel)
- **Balance Metrics**: Additional calculations for performance consistency assessment
- **Archive System**: Organized storage of previous processing results

## Troubleshooting

- **Missing Data Files**: Ensure data files exist in the `DATA/` directory
- **Missing Dependencies**: Install required Python packages using the pip command above
- **File Path Issues**: Ensure the script is run from the `CASP_DATA_PROCESSING/` directory
- **Memory Issues**: For large datasets, consider processing targets individually
- **Plot Generation Errors**: Check that matplotlib backend is properly configured
- **LaTeX Table Errors**: Ensure proper LaTeX installation for PDF generation

## License

This project is licensed under the MIT License. See the license header in each script file for details.

**Author**: Tiburon Leon Benavides  
**Contribution**: Main contributor  
**Date**: 2025-09-01
